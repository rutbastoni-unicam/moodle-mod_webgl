define("mod_webgl/unitygame",["exports","core/ajax","core/modal_events","core/modal_save_cancel","core/str","core/templates","core_course/events","jquery"],(function(_exports,_ajax,_modal_events,_modal_save_cancel,_str,_templates,CourseEvents,_jquery){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modal_events=_interopRequireDefault(_modal_events),_modal_save_cancel=_interopRequireDefault(_modal_save_cancel),_templates=_interopRequireDefault(_templates),CourseEvents=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(CourseEvents),_jquery=_interopRequireDefault(_jquery),window.mod_webgl_plugin={initted:!1,trackGameViewed:()=>{},trackGameProgress:()=>{}};_exports.init=()=>{const showGameCompleteDialog=async()=>{const modalbacktocourse=await _modal_save_cancel.default.create({title:(0,_str.get_string)("gamecompletedialog","mod_webgl"),body:(0,_str.get_string)("gamecompletedialogbody","mod_webgl"),buttons:{cancel:(0,_str.get_string)("gamecompletedialogcancel","mod_webgl"),save:(0,_str.get_string)("gamecompletedialogsave","mod_webgl")}});modalbacktocourse.getRoot().off("click"),modalbacktocourse.getRoot().on(_modal_events.default.save,(()=>{(0,_jquery.default)("#mod_webgl_course_url").submit()})),modalbacktocourse.show()},handleCompletionData=async completiondata=>{const activityInfosBlock=(0,_jquery.default)(".activity-information");if(activityInfosBlock.length){const renderObject=await _templates.default.renderForPromise("core_course/activity_info",completiondata);await _templates.default.replaceNode(activityInfosBlock[0],renderObject.html,renderObject.js)}completiondata.overallcomplete&&showGameCompleteDialog()},setGameLoaded=async()=>{const webglid=(0,_jquery.default)(".webgl-iframe-content-loader").data("webgl"),response=await(0,_ajax.call)([{methodname:"mod_webgl_signal_game_loaded",args:{webglid:webglid}}])[0];response?(handleCompletionData(response.completiondata),window.console.log(response)):window.console.error("Error setting webgl "+webglid+" as viewed")},setGameProgress=async progressData=>{const webglid=(0,_jquery.default)(".webgl-iframe-content-loader").data("webgl");window.console.log("Setting progress data object"),window.console.log(progressData);const score=null!=progressData&&progressData.score?progressData.score:0,completedLevels=null!=progressData&&progressData.completedLevels?progressData.completedLevels:0,puzzleSolved=null!=progressData&&progressData.puzzleSolved?1:0,response=await(0,_ajax.call)([{methodname:"mod_webgl_signal_game_progress",args:{webglid:webglid,score:score,completedlevels:completedLevels,puzzlesolved:puzzleSolved}}])[0];response?(handleCompletionData(response.completiondata),window.console.log(response)):window.console.error("Error setting webgl "+webglid+" progress data")},checkWebglIframeLoaded=()=>{const unityFrame=(0,_jquery.default)(".webgl-iframe-content-loader iframe");if(unityFrame.length<1)return void setTimeout(checkWebglIframeLoaded,250);const unityLoadingBar=unityFrame[0].contentDocument.querySelector("#unity-loading-bar");if(!unityLoadingBar)return void setTimeout(checkWebglIframeLoaded,250);"none"==unityLoadingBar.style.display?(window.console.error("Game loaded, track it"),setGameLoaded()):setTimeout(checkWebglIframeLoaded,250)};window.mod_webgl_plugin.trackGameViewed=setGameLoaded,window.mod_webgl_plugin.trackGameProgress=setGameProgress,window.mod_webgl_plugin.initted=!0,window.addEventListener("gameLoaded",(()=>{window.console.log("gameLoaded event received"),setGameLoaded()})),window.addEventListener("gameProgress",(event=>{window.console.log("gameProgress event received:",event.detail),setGameProgress(event.detail)})),document.addEventListener(CourseEvents.manualCompletionToggled,(e=>{!parseInt(e.detail.withAvailability)&&e.detail.completed&&showGameCompleteDialog()})),checkWebglIframeLoaded();const unityFrame=(0,_jquery.default)(".webgl-iframe-content-loader iframe");if(unityFrame.length){const iframe=unityFrame[0];iframe.addEventListener("load",(()=>{const iframeWindow=iframe.contentWindow;iframeWindow.addEventListener("gameLoaded",(()=>{window.console.log("gameLoaded event received from Webgl frame"),setGameLoaded()})),iframeWindow.addEventListener("gameProgress",(event=>{window.console.log("gameProgress event received from Webgl frame:",event.detail),setGameProgress(event.detail)}))}))}}}));

//# sourceMappingURL=unitygame.min.js.map